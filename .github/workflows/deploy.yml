name: Deploy
permissions: {}

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      branch:
        description: "Branch to deploy"
        required: true
        default: "main"
        type: string

jobs:
  setup-curl:
    runs-on: self-hosted
    outputs:
      curl-updated: ${{ steps.curl-check.outputs.updated }}

    steps:
      - name: Check current curl version
        id: curl-check
        run: |
          echo "Checking current curl version..."
          CURRENT_VERSION=""
          if command -v /usr/local/bin/curl &> /dev/null; then
            CURRENT_VERSION=$(/usr/local/bin/curl --version | head -1 | awk '{print $2}')
            echo "Current local curl version: $CURRENT_VERSION"
          elif command -v curl &> /dev/null; then
            CURRENT_VERSION=$(curl --version | head -1 | awk '{print $2}')
            echo "Current system curl version: $CURRENT_VERSION"
          else
            echo "No curl found"
          fi

          LATEST_TAG=$(curl -s https://api.github.com/repos/curl/curl/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          LATEST_VERSION=$(echo "$LATEST_TAG" | sed 's/curl-//' | sed 's/_/./g')
          echo "Latest available version: $LATEST_VERSION"

          #compare versions
          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "Curl needs updating: $CURRENT_VERSION -> $LATEST_VERSION"
            echo "updated=true" >> $GITHUB_OUTPUT
          else
            echo "Curl is already up to date: $CURRENT_VERSION"
            echo "updated=false" >> $GITHUB_OUTPUT
          fi

      - name: Install curl dependencies
        if: steps.curl-check.outputs.updated == 'true'
        run: |
          echo "Installing dependencies for compiling curl..."
          sudo apt update
          sudo apt install -y \
            build-essential \
            libssl-dev \
            libnghttp2-dev \
            zlib1g-dev \
            libpsl-dev \
            libbrotli-dev \
            libzstd-dev \
            libssh2-1-dev \
            librtmp-dev \
            libldap2-dev \
            libidn2-dev \
            libkrb5-dev \
            autotools-dev

      - name: Build and install latest version of curl
        if: steps.curl-check.outputs.updated == 'true'
        run: |
          echo "Building latest curl..."
          cd /tmp

          TAG_NAME=$(curl -s https://api.github.com/repos/curl/curl/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
          VERSION=$(echo "$TAG_NAME" | sed 's/curl-//' | sed 's/_/./g')
          DOWNLOAD_URL="https://curl.se/download/curl-${VERSION}.tar.gz"

          echo "Downloading curl $VERSION..."
          wget -v "$DOWNLOAD_URL" -O curl-latest.tar.gz

          echo "Extracting and building..."
          tar -xzf curl-latest.tar.gz
          cd curl-${VERSION}

          ./configure --prefix=/usr/local \
                      --with-openssl \
                      --with-nghttp2 \
                      --with-libpsl \
                      --with-brotli \
                      --with-zstd \
                      --enable-http2 \
                      --enable-ldap \
                      --enable-ldaps \
                      --disable-static \
                      --enable-shared

          make -j$(nproc)
          sudo make install
          sudo ldconfig

          echo "✅ Curl installation completed"
          /usr/local/bin/curl --version

          cd /tmp
          rm -rf curl-latest.tar.gz curl-${VERSION}

  deploy:
    runs-on: self-hosted # REQUIRES SOME SUDO EXECUTION PRIVILEGES WITHOUT A PASSWORD PROMPT
    needs: setup-curl

    steps:
      - name: Stopping systemd service
        run: sudo systemctl stop discordbot

      - name: Pulling latest changes
        working-directory: /home/vb2007/prod/discordbot
        run: |
          BRANCH="${{ github.event.inputs.branch || 'main' }}"
          echo "Deploying branch: $BRANCH"
          git fetch origin
          git reset --hard origin/$BRANCH
          git clean -fd
          echo "✅ Successfully pulled latest changes from $BRANCH"

      # i use manual node paths and manage version manually w/ nvm
      # - name: Setup Node.js
      #   uses: actions/setup-node@v4
      #   with:
      #     node-version: "24.8.0"

      - name: Installing Node.js dependencies
        working-directory: /home/vb2007/prod/discordbot
        env:
          PATH: /usr/local/bin:/home/vb2007/.nvm/versions/node/v24.8.0/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        run: |
          rm -rf node_modules
          npm ci
          echo "✅ Dependencies installed successfully"

      - name: Deploying possible new commands
        working-directory: /home/vb2007/prod/discordbot
        env:
          PATH: /usr/local/bin:/home/vb2007/.nvm/versions/node/v24.8.0/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        run: |
          echo "Starting command deployment..."
          deployOutput=$(npm run deploy 2>&1)
          echo "$deployOutput"

          if echo "$deployOutput" | grep -q "Registered .* slash (/) commands at Discord"; then
            echo "✅ Command deployment successful"
          else
            echo "❌ Command deployment failed"
            exit 1
          fi
          sleep 8

      - name: Updating command data
        working-directory: /home/vb2007/prod/discordbot
        env:
          PATH: /usr/local/bin:/home/vb2007/.nvm/versions/node/v24.8.0/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
        run: |
          echo "Starting table creation and command data update..."
          queriesOutput=$(npm run create-tables 2>&1)
          echo "$queriesOutput"

          if echo "$queriesOutput" | grep -q "All queries are executed & all tables are processed." && echo "$queriesOutput" | grep -q "Command data has been updated successfully."; then
            echo "✅ Table creation and command data update successful"
          else
            echo "❌ Table creation or command data update failed"
            exit 1
          fi
          sleep 5

      - name: Starting systemd service
        run: |
          sudo systemctl start discordbot
          sleep 5
          sudo systemctl status discordbot --no-pager
          echo "Systemd service started"

      - name: Verifying deployment outcome
        run: |
          echo "Waiting for the service to start"
          sleep 10

          if sudo systemctl is-active --quiet discordbot.service; then
            echo "✅ Deployment successful - service is running"
          else
            echo "❌ Deployment failed - service is not running"
            sudo systemctl status discordbot.service --no-pager
            exit 1
          fi
